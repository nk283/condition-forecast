# v1.4 リリースノート

## 🎉 v1.4-automation リリース概要

このバージョンでは、ユーザーのリクエストに基づいて以下の3つの主要機能を実装しました：

1. **スコア算出根拠の詳細表示** - 各スコアの計算理由を明確に表示
2. **デスクトップショートカット作成** - ワンクリックで体調予報を実行
3. **Windows Task Scheduler 自動実行設定** - 毎日自動でデータを蓄積

---

## ✨ 実装した新機能

### 1. スコア算出根拠の詳細表示

**目的**: ユーザーが「気温が100点なのはなぜ？」という質問に対して、実際のデータに基づいた説明を表示

**実装内容**:
- `reportGenerator.js` に新メソッド `getScoreReasoning()` を追加
- テキストレポートに「📐 スコア算出根拠」セクションを追加

**表示例**:
```
📐 スコア算出根拠:
─────────────────────
• 気温: 10.71℃は快適範囲(5-20℃)内のため98点
• 気温差: 日中の気温差が安定(≤10℃)しているため100点
• 湿度: 53%は最適範囲(40-60%)内のため100点
• 日照: 雲量75%で曇天のため50点
• 空気質: 屋内のみの予定のため影響なし、100点
• 気圧: 1020 hPaは許容範囲(990-1030 hPa)のため80点
• スケジュール: 特に負担となる予定がないため100点
```

**ファイル変更**:
- `src/utils/reportGenerator.js`: `getScoreReasoning()` メソッド追加（約90行）

---

### 2. デスクトップショートカット作成

**目的**: ユーザーがマウスクリック1つで体調予報を実行できるようにする

**実装内容**:
- PowerShell スクリプト `create_desktop_shortcut.ps1` を作成
- Windows COM オブジェクト (`WScript.Shell`) を使用してショートカット作成

**使用方法**:
```bash
powershell -ExecutionPolicy Bypass -File create_desktop_shortcut.ps1
```

**結果**:
- デスクトップに「体調予報.lnk」ショートカットが作成される
- このショートカットをダブルクリックで体調予報が実行される

**ファイル**:
- `create_desktop_shortcut.ps1`（新規作成）

---

### 3. Windows Task Scheduler 自動実行設定

**目的**: 毎日自動で体調予報を実行し、スコアデータを蓄積できるようにする

**実装内容**:
- PowerShell スクリプト `setup_task_scheduler.ps1` を作成
- Task Scheduler に「体調予報システム_毎日実行」タスクを登録

**使用方法**:
```bash
# PowerShell を『管理者として実行』で開く
powershell -ExecutionPolicy Bypass -File setup_task_scheduler.ps1
```

**設定内容**:
- **タスク名**: 体調予報システム_毎日実行
- **実行時間**: 毎日朝8時（カスタマイズ可能）
- **実行スクリプト**: `run_daily_forecast.ps1`
- **実行ディレクトリ**: `C:\Users\user\claude\Projects\Condition_Forecast`

**ファイル**:
- `setup_task_scheduler.ps1`（新規作成）
- `run_daily_forecast.ps1`（改善）
- `run_forecast.bat`（改善）

**確認方法**:
1. Windows キー + R で `taskschd.msc` を実行
2. タスク スケジューラー ライブラリで「体調予報システム_毎日実行」を検索

---

## 📊 v1.4 での体調スコア計算方式

### 7つの要因による加重平均スコア

| 要因 | 配重 | 計算方法 |
|------|------|--------|
| 🌡️ 気温 | 20% | 最適範囲5-10℃。快適範囲5-20℃。外部：線形減点 |
| 🌡️ 気温差 | 5% | 日中気温差≤10℃で100点。1℃超過ごとに3点減点 |
| 💧 湿度 | 15% | 最適40-60%。気温20℃以上で高湿度の影響大 |
| ☀️ 日照 | 20% | 雲量0-20%で100点。20%増ごとに段階的に減点 |
| 💨 空気質 | 15% | AQI指標。屋外予定がない場合は100点 |
| 🎈 気圧 | 10% | 1010-1015 hPaで100点。逸脱度に応じて減点 |
| 📅 スケジュール | 15% | 会合-15点、外出-10点、睡眠阻害-20点、食事阻害-10点 |

**総合スコア** = Σ(各要因スコア × 配重) = 0-100

---

## 📁 新規・修正ファイル一覧

### 新規作成ファイル
```
create_desktop_shortcut.ps1          # デスクトップショートカット作成スクリプト
setup_task_scheduler.ps1            # Task Scheduler 設定スクリプト
v1.4_RELEASE_NOTES.md               # このファイル
```

### 修正ファイル
```
src/utils/reportGenerator.js         # スコア算出根拠表示機能を追加
run_forecast.bat                     # 改善（コメント追加）
run_daily_forecast.ps1               # 改善（コメント追加）
README.md                            # ドキュメント更新
```

---

## 🚀 使用手順

### A. 初回セットアップ（デスクトップショートカット作成）

```bash
# PowerShell を起動（管理者権限は不要）
powershell -ExecutionPolicy Bypass -File create_desktop_shortcut.ps1
```

**結果**: デスクトップに「体調予報」ショートカットが作成されます

---

### B. 初回セットアップ（毎日自動実行）

```bash
# PowerShell を『管理者として実行』で起動
powershell -ExecutionPolicy Bypass -File setup_task_scheduler.ps1
```

**結果**: Task Scheduler に毎日朝8時に自動実行されるタスクが登録されます

**注意**: 管理者権限が必要です。権限がない場合はエラーが表示されます。

---

### C. 手動実行

以下のいずれかの方法で実行できます：

1. **デスクトップショートカット**: ダブルクリック
2. **コマンドライン**:
   ```bash
   npm start
   ```
3. **バッチファイル**:
   ```bash
   run_forecast.bat
   ```

---

## ✅ 動作確認済み機能

- ✅ スコア算出根拠が正常に表示される
- ✅ 7つの要因すべてが詳細に説明される
- ✅ デスクトップショートカットが正常に作成される
- ✅ ショートカットをクリックで体調予報が実行される
- ✅ HTML ダッシュボードが正常に生成される
- ✅ 過去データと未来予測データが正常に表示される

---

## 🔄 データ蓄積について

**過去15日間のデータがない状態での動作**:

現在の実行日が2月10日（月）の場合：
- 初回実行: 2月10日のデータのみ存在
- グラフの「スコアの推移（過去7日間）」には2月10日のデータのみ表示
- 時系列グラフの青線は2月10日の1点だけ

**15日後の動作**:

2月25日になると：
- グラフに2月18日～2月25日の過去8日分のデータが表示される
- 「スコアの推移」に過去7日分のデータが表示される
- より有意義なデータトレンドが確認できます

**推奨アクション**:
1. 今日から毎日自動実行を設定する
2. 2週間後には過去データのグラフが完全に表示される
3. 日々のスコア推移を観察して、パターンを発見できる

---

## 📈 今後の改善予定

### Phase 5（検討中）
- [ ] Web ダッシュボード（React/Next.js）
- [ ] グラフの相互作用性向上
- [ ] 過去データとの相関分析
- [ ] 予測精度の向上（機械学習）

### Phase 6（検討中）
- [ ] スマートフォンアプリ化
- [ ] ユーザーパラメータ調整UI
- [ ] クラウド同期機能
- [ ] 家族・複数ユーザー対応

---

## 🐛 既知の制限事項

1. **OpenWeather 無料プラン**: 5日間予報のみ（7日間は有料）
2. **未来スケジュール**: 今後のスケジュール予測は含まれない（Google Calendar の未来予定取得が複雑化するため）
3. **空気質**: 現在はサンプル値使用（WAQI API 統合は Phase 5 計画）
4. **管理者権限**: Task Scheduler 登録には管理者権限が必須

---

## 💡 トラブルシューティング

### Task Scheduler 登録時に「アクセス拒否」エラーが出る場合

**原因**: 管理者権限なしで実行

**解決方法**:
1. PowerShell を右クリック
2. 「管理者として実行」を選択
3. スクリプトを再度実行

### デスクトップショートカットが作成されない場合

**原因**: PowerShell 実行ポリシー制限

**解決方法**:
```bash
powershell -ExecutionPolicy Bypass -File create_desktop_shortcut.ps1
```
※ `-ExecutionPolicy Bypass` フラグを指定

### 毎日朝8時に自動実行されない場合

**確認方法**:
1. `taskschd.msc` を実行
2. 「タスク スケジューラー ライブラリ」で「体調予報システム_毎日実行」を右クリック
3. 「プロパティ」で状態確認
4. 実行ログを確認：`logs/forecast_log.txt`

---

## 📝 Git タグ・バージョン管理

| タグ | 説明 |
|------|------|
| v1.0-base | 基本機能実装 |
| v1.1-calendar | Google Calendar OAuth 連携 |
| v1.2-dashboard | 静的 HTML ダッシュボード生成 |
| v1.3-forecast | 気温差、日照実データ化、未来5日予報 |
| **v1.4-automation** | **スコア算出根拠、自動実行機能（現在地）** |

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. `.env` ファイルが正しく設定されているか
2. OpenWeather API キーが有効か（https://openweathermap.org/ で確認）
3. Google Calendar 認証済みか（`token.json` が存在するか）
4. Node.js と npm がインストールされているか

---

**最終更新**: 2026年2月10日
**バージョン**: 1.4-automation
