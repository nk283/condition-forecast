# パソコン起動時トリガー設定ガイド

## 概要
体調予報システムを **パソコン起動時**（休止状態から復帰を含む）に自動実行する設定です。

## 動作仕様
| 状態 | 動作 |
|------|------|
| **パソコン起動時** | ✅ 実行 |
| **休止状態から復帰** | ✅ 実行 |
| **スリープから復帰** | ⚠️ 実行されない（Windows仕様） |
| **短時間に複数回起動** | ✅ 重複実行なし |

## 設定手順

### ステップ 1: タスク スケジューラーを開く

1. **Windows キー + R** を押す
2. `taskschd.msc` と入力して **Enter** キーを押す
3. **タスク スケジューラー** ウィンドウが開きます

### ステップ 2: 既存タスクを確認・削除（存在する場合）

1. 左側のペインで「**タスク スケジューラー ライブラリ**」をクリック
2. 中央のペインで「体調予報システム_毎日実行」を探す
3. 見つかった場合は右クリック → 「**削除**」

### ステップ 3: 新規タスクを作成

1. 右側のペインで「**基本タスクの作成...**」をクリック
2. **「基本タスクの作成」ウィザード** が開きます

#### 1) 名前と説明を入力
- **名前**: `体調予報システム_毎日実行`
- **説明**: `パソコン起動時に体調予報を実行（休止状態復帰含む）`
- **[次へ]** をクリック

#### 2) トリガーを設定
- **「トリガー」** 画面で「**起動時**」を選択
- 説明: 「タスクコンピューターの起動時に開始します」
- **[次へ]** をクリック

#### 3) アクション（実行内容）を設定
- **「アクション」** 画面で「**プログラムの開始**」を選択（既にデフォルト）
- **[次へ]** をクリック

#### 4) 詳細設定（プログラムパス）
- **「プログラム/スクリプト」**:
  ```
  PowerShell.exe
  ```

- **「引数の追加(オプション)」**:
  ```
  -ExecutionPolicy Bypass -File "C:\Users\user\claude\Projects\Condition_Forecast\run_daily_forecast.ps1"
  ```

- **[次へ]** をクリック

#### 5) 完了確認
- **「完了」** 画面が表示されます
- ✅ **「完了時にこのタスクのプロパティを開く」** にチェック
- **[完了]** をクリック

### ステップ 4: タスクの詳細設定（重要：重複実行防止）

**ステップ 3 で「完了」をクリックすると、自動的にプロパティが開きます**

#### タブ: 「全般」
- **セキュリティ オプション**:
  - 「最上の権限で実行する」: チェック不要（ユーザー権限で実行）

#### タブ: 「トリガー」
- 作成したトリガー「起動時」をダブルクリック
- **「詳細設定」** セクション:
  - ☑️ **「複数のインスタンスがある場合に次の規則を適用する」**: チェック
  - ドロップダウン: **「既存のインスタンスを無視する」** を選択
  - **[OK]** をクリック

#### タブ: 「条件」
- **「コンピューターが休止状態になっていた場合、この条件の確認時にタスクを起動する」**:
  - ☑️ チェック（これにより休止状態復帰時に実行される）

#### タブ: 「設定」
- **「このタスクは次の場合に実行することを許可する」**:
  - ☑️ 「タスクがコンピューターでコンピューター アカウント（システム）として実行されている場合、デマンドで実行する」

### ステップ 5: 設定を保存

1. ウィンドウ下部の **[OK]** をクリック
2. **UAC（ユーザーアカウント制御）** ダイアログが表示される場合は **[はい]** をクリック

### ステップ 6: 設定確認

1. タスク スケジューラー画面に戻る
2. 「タスク スケジューラー ライブラリ」で「**体調予報システム_毎日実行**」を選択
3. **状態**: 「準備完了」または「実行中」で表示
4. **トリガー**: 「起動時」と表示

## テスト方法

### 方法1: パソコンを再起動
1. パソコンを再起動
2. ログイン後、ログフォルダ（`logs/forecast_log.txt`）を確認
3. 実行ログが記録されていることを確認

### 方法2: タスク スケジューラーから手動実行
1. タスク スケジューラーで「体調予報システム_毎日実行」を右クリック
2. 「**実行**」をクリック
3. 数秒後に実行完了
4. ログファイルで結果を確認

## トラブルシューティング

### Q: タスクが実行されていないようです
**A**: 以下を確認してください
- [ ] タスク スケジューラーで「状態」が「準備完了」になっているか
- [ ] 「トリガー」に「起動時」が登録されているか
- [ ] 「設定」タブで「トリガーが発生したときにタスクをオンのまま実行し続ける」がチェックされているか
- [ ] `logs/forecast_log.txt` に実行ログが記録されているか

### Q: スクリプトが見つからないというエラーが出ます
**A**: 以下を確認してください
- [ ] ファイルパス `C:\Users\user\claude\Projects\Condition_Forecast\run_daily_forecast.ps1` が正しいか
- [ ] ユーザー名が「user」であるか（異なる場合は修正が必要）

### Q: PowerShell実行ポリシーエラーが出ます
**A**: 以下のコマンドをPowerShell（管理者として実行）で実行
```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force
```

### Q: 休止状態から復帰しても実行されません
**A**: 以下を確認してください
- [ ] タスク プロパティの「条件」タブで「コンピューターが休止状態になっていた場合...」がチェックされているか
- [ ] 「設定」タブで「このタスクは次の場合に実行することを許可する」がチェックされているか

## ファイル構成

```
Condition_Forecast/
├── run_daily_forecast.ps1    ← 実行スクリプト
├── src/
│   ├── index.js
│   └── ...
├── logs/
│   └── forecast_log.txt       ← 実行ログ（自動生成）
└── data/
    └── hourly_scores.json     ← 蓄積データ（自動生成）
```

## 詳細説明

### なぜ「起動時トリガー」を選んだのか？

ユーザーは「休止状態を使用するため、起動時トリガーで十分」とのご指摘。

| トリガー方式 | 起動時 | 定期実行（毎日8時） |
|---|---|---|
| パソコン起動時 | ✅ 実行 | ✅ 実行 |
| 休止状態から復帰 | ✅ 実行 | ❌ 実行されない |
| データ蓄積 | 毎日複数回（起動回数分） | 毎日1回のみ |

**起動時トリガー採用の理由**:
- 毎日複数回起動することはない（実際の使用パターン）
- 休止状態から復帰時にすぐ体調予報が実行される
- 自動実行される確実性が高い

### 重複実行防止（MultipleInstances IgnoreNew）

この設定により、以下が実現されます：

```
時間軸:     08:00    08:05    08:10
起動1:      ● 実行
起動2:             ● スキップ（前回実行中）
起動3:                     ● スキップ（前回実行中）
```

前回の実行が完了するまで、次の起動トリガーは無視されます。

## 参考: PowerShell スクリプトの内容

`run_daily_forecast.ps1` は以下を実行します：

```powershell
# 1. 体調予報を実行
npm start

# 2. 実行ログを記録
```

データは `data/hourly_scores.json` に自動保存され、毎日蓄積されます。

---

**最終確認**:
- ✅ タスク名: 「体調予報システム_毎日実行」
- ✅ トリガー: 「起動時」
- ✅ スクリプト: `C:\Users\user\claude\Projects\Condition_Forecast\run_daily_forecast.ps1`
- ✅ 重複実行防止: 有効

これで設定は完了です。次回パソコン起動時または休止状態から復帰時に体調予報が自動実行されます。
